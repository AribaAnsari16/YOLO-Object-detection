a
    â‚¬&5fÂC  Ã£                   @   s  d dl Z d dlZd dlZd dlmZ d dlmZ d dl Zd dl	Z	d dl
Z
d dl
m
Z
 d dlm
Z
 d dlmZ d d lmZmZmZmZmZmZmZmZmZmZmZmZmZ d dlmZm Z  d d	l!m"Z"m#Z#m$Z$ d d
l%m&Z&m'Z'm(Z( dd
dd
dddddddedÆ’ddddddddddfddâ€Z)e*dkÂre j+ddÂZ,e,j-dde.dddÂ e,j-de.dddÂ e,j-d e/d
d!dÂ e,j-d"e/dd#dÂ e,j-d$e0d
d%dÂ e,j-d&e0d'd(dÂ e,j-d)d*d+d,Â e,j-d-dd.d,Â e,j-d/d0d1d2Â e,j-d3d0d4d2Â e,j-d5d0d6d2Â e,j-d7d0d8d2Â e,j-d9d0d:d2Â e,j-d;d0d<d2Â e,j-d=d0d>d2Â e,j-d?d@dAd,Â e,j-dBdCdAd,Â e,j-dDd0dEd2Â e,j-dFd0dGd2Â e,j-dHd0dId2Â e,Â 1Â¡ Z2e2 j3e2j4Â 5dJÂ¡O  _3ee2j4Æ’e2_4e6e2Æ’ e2j7dKv Âre)e2j4e2j8e2j9e2j:e2j;e2j<e2j3e2j=e2j>e2j?e2j@e2jAB e2jAe2jBe2jC e2jDdLÂ Âne2j7dMkÂrJe2j8D ](ZEe)e2j4eEe2j9e2j:dNdOdde2jDdPÂ	 ÂqnÃe2j7dQkÂreFeGdRdSdTÆ’Æ’ZHe2j8D ]â€“ZEdUee2j4Æ’jIâ€º dVeeEÆ’jIâ€º dWÂZJg ZKeHD ]VZLe6dXeJâ€º dYeLâ€º dZÂÆ’ e)e2j4eEe2j9eLe2j;e2j<e2j3de2jDd[Â	\ZMZNZOeKÂ PeMeO Â¡ ÂqËœejQeJeKd\d]Â ÂqleÂ Rd^Â¡ e$eHd_Â dS )`Ã©    N)ÃšPath)ÃšThread)Ãštqdm)Ãšattempt_load)Ãšcreate_dataloader)
Ãšcoco80_to_coco91_classÃš
check_datasetÃš
check_fileÃšcheck_img_sizeÃšcheck_requirementsÃš box_iouÃšnon_max_suppressionÃšscale_coordsÃš	xyxy2xywhÃš	xywh2xyxyÃš
set_loggingÃšincrement_pathÃšcolorstr)Ãšap_per_classÃšConfusionMatrix)Ãš
plot_imagesÃšoutput_to_targetÃšplot_study_txt)Ãš
select_deviceÃštime_synchronizedÃš
TracedModelÃ©    iâ‚¬  gÃ¼Â©Ã±Ã’MbP?g333333Ã£?FÃš Tc           j   
      s
  |
d u}|rt |
Â Â¡ Æ’j}nË†tÆ’  ttj|dÂ}tt ttjÆ’tj	 tj
dÂÆ’}|
rZ|d n|j
dddÂ t||dÂ}
t
t|
jÂ 
Â¡ Æ’d Æ’}t||dÂ}|rÂ¤t|
||Æ’}
|jd	koÂ°|}|rÂ¾|
Â Â¡  |
Â Â¡  t| tÆ’Âr| Â d
Â¡}t| Æ’Â }tj|tjd
Â} W d   Æ’ n1 Âs0    Y  t| Æ’ | Âr(dn
t| d
 Æ’}tÂ dddÂ¡Â |Â¡}|Â  Â¡ }d}Ë†ÂrnË†j!Ârnt"Ë†j#dÆ’}|ÂsÃ¨|jd	kÂrÂ¨|
tÂ $dd||Â¡Â |Â¡Â %t |
Â Â¡ Æ’Â¡Æ’ tj&dv ÂrÂºtj&nd} t'| |  |||tddt(| â€º dÂÆ’dÂd }
|ÂrÃ¶t)dÆ’ dâ€°t*|dÂ}!ddâ€ t+t,|
dÆ’Âr|
j-n|
j.j-Æ’D Æ’â€° t/Æ’ }"dd }#d\	}$}%}&}'}(})}*}+},tj$d|d Â}-g g g g g f\}.}/}0}1}2t+t0|
|#d!ÂÆ’D Â]Â¨\}3\}4â€°}5}6|4j|dd"Â}4|ÂrÂ´|4Â Â¡ n|4Â 1Â¡ }4|4d# }4Ë†Â |Â¡â€°|4j2\}7}8}9}:tÂ 3Â¡ ÂÃ” t4Æ’ };|
|4|d$Â\}<}=|+t4Æ’ |; 7 }+|Âr4|-|d%d&â€ |=D Æ’Ë†Æ’d d dâ€¦ 7 }-Ë†d d â€¦d'd â€¦f  tÂ 5|:|9|:|9gÂ¡Â |Â¡9  < |Ârâ‚¬â€¡fd(d&â€t6|7Æ’D Æ’ng }>t4Æ’ };t7|<|||>dd)Â}<|,t4Æ’ |; 7 },W d   Æ’ n1 ÂsÃ€0    Y  t+|<Æ’D Â]Ã¬\}?}@Ë†Ë†d d â€¦df |?kdd â€¦f }At8|AÆ’}B|BÂr|Ad d â€¦df Â 9Â¡ ng }Ct|5|? Æ’}DË†d7 â€°t8|@Æ’dkÂrv|BÂrÃ’|/Â :tj$d|tj;d*ÂtÂ 5Â¡ tÂ 5Â¡ |CfÂ¡ ÂqÃ’|@Â <Â¡ }Et=|4|? j2dd â€¦ |Ed d â€¦d d+â€¦f |6|? d |6|? d Æ’ |
ÂrÂtÂ >|6|? d Â¡g d,Â¢ }F|EÂ 9Â¡ D ]Â¬Â^ }G}H}It?tÂ >|GÂ¡Â @dd+Â¡Æ’|F Â @d-Â¡Â 9Â¡ }J|Âr(|Ig|JÂ¢|Hâ€˜R n
|Ig|JÂ¢R }Kt|d |DjAd.  d/Æ’Â.}|Â Bd0t8|KÆ’ Â CÂ¡ |K d1 Â¡ W d   Æ’ n1 Âsâ€š0    Y  ÂqÃ¢t8|2Æ’|k ÂrÃ¾Ë†jDdkÂrÃ¾Ë†jDË†jE dkÂrÃ¾â€¡ fd2d&â€|@Â 9Â¡ D Æ’}Ld3|LË† d4Å“i}M|2Â :Ë†j!jF|4|? |M|Dj	d5ÂÂ¡ Ë†ÂrË†jGÂrË†Â H|E|DË† Â¡nd  |ÂrÃ¬|DjAÂ IÂ¡ Âr:t|DjAÆ’n|DjA}Nt?|Ed d â€¦d d+â€¦f Æ’}O|Od d â€¦d d'â€¦f  |Od d â€¦d'd â€¦f d' 8  < tJ|@Â 9Â¡ |OÂ 9Â¡ Æ’D ]P\}$}P|.Â :|N|ÂrÂ¾|"t|$d6 Æ’ n
t|$d6 Æ’d7d&â€ |PD Æ’tK|$d+ d6Æ’d8Å“Â¡ ÂqÅ¡tj$|@j2d |tj;|d9Â}Q|BÂrË†g }R|Ad d â€¦df }StL|Ad d â€¦dd6â€¦f Æ’}Tt=|4|? j2dd â€¦ |T|6|? d |6|? d Æ’ |Â râ€™|!Â M|EtÂ N|Ad d â€¦ddâ€¦f |TfdÂ¡Â¡ tÂ O|SÂ¡D ]Ãª}I|I|SkjPd:d;ÂÂ @d-Â¡}U|I|@d d â€¦d6f kjPd:d;ÂÂ @d-Â¡}V|Vj2d Â rÅ“tQ|E|Vd d+â€¦f |T|U Æ’Â 
dÂ¡\}W}XtRÆ’ }Y|W|d kjPd:d;ÂD ]`}Z|U|X|Z  }[|[Â SÂ¡ |YvÂr"|YÂ T|[Â SÂ¡ Â¡ |RÂ :|[Â¡ |W|Z |k|Q|V|Z < t8|RÆ’|BkÂr" Â qÅ“Âq"Â qÅ“|/Â :|QÂ UÂ¡ |@d d â€¦d+f Â UÂ¡ |@d d â€¦d6f Â UÂ¡ |CfÂ¡ ÂqÃ’|Ârâ€ |3dk Ârâ€ |d<|3â€º d=Â }tVtW|4Ë†|5|Ë† fdd>ÂÂ XÂ¡  |d<|3â€º d?Â }tVtW|4tY|<Æ’|5|Ë† fdd>ÂÂ XÂ¡  Âqâ€ d@d&â€ tJ|/Å½ D Æ’}/t8|/Æ’Â	rÃ–|/d Â ZÂ¡ Â	rÃ–t[|/|||Ë† dAÅ“Å½\}$}%}0}&}1|0d d â€¦df |0Â \dÂ¡ }\}0|$Â \Â¡ |%Â \Â¡ |\Â \Â¡ |0Â \Â¡ f\}'}(})}*t]j^|/d Â _t]j`Â¡|dBÂ}]n
tÂ $dÂ¡}]dC}^t)|^dDË†|]Â aÂ¡ |'|(|)|*f  Æ’ |	Â
s|dEk Â
rr|Â
sr|dkÂ
rrt8|/Æ’Â
rrt+|1Æ’D ]<\}X}_t)|^Ë† |_ Ë†|]|_ |$|X |%|X |\|X |0|X f  Æ’ Â
q4tbâ€¡fdFdGâ€|+|,|+|, fD Æ’Æ’|||f };|Â
sÂ®t)dH|; Æ’ |Â
r|!jc|tdË† Â eÂ¡ Æ’dIÂ Ë†Â
rË†j!Â
râ€¡fdJd&â€tf|Â gdKÂ¡Æ’D Æ’}`Ë†Â hdL|`iÂ¡ |2Â
rË†Â hdM|2iÂ¡ |Ârbt8|.Æ’Ârb|d uÂ
rNtt|tdÆ’Â
rF|d n|Æ’jAndN}adO}bt||aâ€º dPÂ Æ’}ct)dQ|c Æ’ t|cdRÆ’Â}tiÂ j|.|Â¡ W d   Æ’ n1 Â
sÂ¢0    Y  zâ‚¬ddSlkml}d ddTlmmn}e |d|bÆ’}f|fÂ o|cÂ¡}@|e|f|@dUÆ’}g|Âr dVd&â€ |
jpjqD Æ’|gjr_s|gÂ tÂ¡  |gÂ uÂ¡  |gÂ vÂ¡  |gjwd d'â€¦ \}*})W n4 txÂy` }h zt)dW|hâ€º ÂÆ’ W Y d }h~hn
d }h~h0 0 |
Â 1Â¡  |ÂsÂ®|
ÂrËœd1t8td|Â gdXÂ¡Æ’Æ’â€º dY|d â€º ÂndN}#t)dZ|â€º |#â€º ÂÆ’ t]Â $|Â¡|* }it+|1Æ’D ]\}X}_|0|X |i|_< ÂqÃ„|'|(|)|*g|-Â UÂ¡ t8|
Æ’ Â 9Â¡ Â¢R |i|;fS )[N)Ãš
batch_size)Ãšexist_okÃšlabelsT)Ãš parentsr   )Ãšmap_locationr   )ÃšsÃšcpuÃº	coco.yaml)ÃšLoaderÃ©   Ãšncg      Ã ?gffffffÃ®?Ã©
   r   Ã©d   Ã©   Â©ÃštrainÃšvalÃštestr.   z: )ÃšpadÃšrectÃšprefixz Testing with YOLOv5 AP metric...)r(   c                 S   s   i | ]\}}||â€œqS Â© r3   )Ãš.0ÃškÃšvr3   r3   Ãº+C:\Users\amn_o\yolov7\yolov7-custom\test.pyÃš
<dictcomp>b   Ã³    ztest.<locals>.<dictcomp>Ãšnamesz%20s%12s%12s%12s%12s%12s%12s) ZClassZImagesZLabelsÃšPÃšRzmAP@.5z
mAP@.5:.95)	Ã§        r=   r=   r=   r=   r=   r=   r=   r=   )Ãšdevice)Ãšdesc)Ãšnon_blockingg     Ã o@)Ãš augmentc                 S   s   g | ]}|Â  Â¡ â€˜qS r3   )ÃšfloatÂ©r4   Ãšxr3   r3   r7   Ãš
<listcomp>w   r9   ztest.<locals>.<listcomp>Ã©   c                    s,   g | ]$}Ë† Ë† d d â€¦df |kdd â€¦f â€˜qS )Nr   r'   r3   )r4   Ãši)Ãš targetsr3   r7   rE   {   r9   )Ãš
conf_thresÃš	iou_thresr    Z
multi_label)ÃšdtypeÃ©   )r'   r   r'   r   Ã©Ã¿Ã¿Ã¿Ã¿Ãº.txtÃšaz%g Ãš
c                    sR   g | ]JÂ^ }}}|d  |d |d |d dÅ“t |Æ’dË† | |f d|id dÅ“â€˜qS )	r   r'   rF   r+   )ZminXZminYZmaxXZmaxYz %s %.3fZ
class_scoreZpixel)ÃšpositionZclass_idZ
box_captionÃšscoresÃšdomain)Ãšint)r4   ÃšxyxyÃšconfÃšcls)r:   r3   r7   rE   Â   s   
Ã¼Ã¼Ãš
predictions)Ãšbox_dataZclass_labels)ÃšboxesÃš captionÃ©   c                 S   s   g | ]}t |d Æ’â€˜qS )r+   )ÃšroundrC   r3   r3   r7   rE   Â¯   r9   )Ãšimage_idZ
category_idÃšbboxÃšscore)rK   r>   F)Ãšas_tupleZ
test_batchz
_labels.jpg)ÃštargetÃšargsÃšdaemonz	_pred.jpgc                 S   s   g | ]}t Â |d Â¡â€˜qS )r   )ÃšnpÃš
concatenaterC   r3   r3   r7   rE   Ã   r9   )ÃšplotÃš	v5_metricÃšsave_dirr:   )Ãš	minlengthz$%20s%12i%12i%12.3g%12.3g%12.3g%12.3gÃšallÃ©2   c                 3   s   | ]}|Ë†  d  V  qdS )g     @Â@Nr3   rC   )Ãšseenr3   r7   Ãš	<genexpr>Ã±   r9   ztest.<locals>.<genexpr>zMSpeed: %.1f/%.1f/%.1f ms inference/NMS/total per %gx%g image at batch-size %g)ri   r:   c                    s"   g | ]}Ë† j jt|Æ’|jd Ââ€˜qS ))r[   )ÃšwandbÃšImageÃšstrÃšname)r4   Ãšf)Ãšwandb_loggerr3   r7   rE   Ã¹   r9   z	test*.jpgZ
ValidationzBounding Box Debugger/Imagesr   z)./coco/annotations/instances_val2017.jsonz_predictions.jsonz+
Evaluating pycocotools mAP... saving %s...Ãšw)ÃšCOCO)ÃšCOCOevalr_   c                 S   s   g | ]}t t|Æ’jÆ’â€˜qS r3   )rT   r   ÃšstemrC   r3   r3   r7   rE     r9   zpycocotools unable to run: zlabels/*.txtz labels saved to zResults saved to )yÃšnextÃš
parametersr>   r   r   Ãšoptr   r   Ãš projectrr   r   Ãšmkdirr   ÃšmaxrT   Ãšstrider
   r   ÃštypeÃšhalfÃševalÃš
isinstancerq   ÃšendswithÃšopenÃšyamlÃšloadÃš
SafeLoaderr   ÃštorchÃšlinspaceÃštoÃšnumelro   ÃšminÃšlog_imgsÃšzerosÃš type_asÃštaskr   r   Ãšprintr   Ãš	enumerateÃš hasattrr:   Ãšmoduler    r   rB   ÃšshapeÃš no_gradr   ÃšTensorÃšranger
   ÃšlenÃštolistÃšappendÃšboolÃšcloner   Ãštensorr   Ãšviewrx   ÃšwriteÃšrstripÃš
current_epochZ
bbox_intervalrp   Ãš	wandb_runZlog_training_progressÃš	isnumericÃšzipr]   r   Z
process_batchÃšcatÃšuniqueÃš nonzeror   ÃšsetÃšitemÃšaddr$   r   r   Ãšstartr   Ãšanyr   Ãšmeanre   ÃšbincountÃšastypeÃšint64ÃšsumÃštuplerg   ÃšlistÃšvaluesÃšsortedÃšglobÃšlogÃšjsonÃšdumpZpycocotools.cocorv   Zpycocotools.cocoevalrw   Z loadResÃš datasetZ	img_filesÃšparamsZimgIdsZevaluateÃš
accumulateÃš	summarizeÃšstatsÃš	Exception)jÃšdataÃš weightsr   ÃšimgszrI   rJ   Ãš	save_jsonÃš
single_clsrA   Ãš verboseÃšmodelÃš
dataloaderri   Ãšsave_txtÃš
save_hybridÃš	save_confÃšplotsrt   Ãšcompute_lossZhalf_precisionÃštraceÃš is_cocorh   Ãštrainingr>   ÃšgsrÂ   rs   r(   ZiouvZniourÅ½   râ€˜   Zconfusion_matrixZ
coco91classr#   ÃšpÃšrÃšf1ÃšmpÃšmrZmap50ÃšmapÃšt0Ãšt1ÃšlossZjdictrÃ€   ZapZap_classZwandb_imagesZ batch_iÃšimgÃšpathsÃšshapesÃšnbÃš_ÃšheightÃšwidthÃštÃšoutZ	train_outÃšlbÃšsiÃšpredr    ÃšnlZtclsÃšpathZprednÃšgnrU   rV   rW   ZxywhÃšlinerY   rZ   r^   ÃšboxÃšbZ correctZdetectedZ
tcls_tensorZtboxÃštiÃšpiZiousrG   Zdetected_setÃšjÃšdZap50ÃšntZpfÃšcZ
val_batchesru   Z	anno_jsonZ	pred_jsonrv   rw   Ãšannorâ€š   ÃšeÃšmapsr3   )r:   rm   rH   rt   r7   r/      sf   

0(Ã¿Ã¿
("

$0 . (<$"B
Ã¼ 0 Ã½,("$
:$$
*6*,,
$,r/   Ãš__main__z test.py)Ãšprogz	--weightsÃº+z	yolov7.ptzmodel.pt path(s))Ãšnargsrâ‚¬   Ãš defaultÃšhelpz--datazdata/coco.yamlz
*.data path)râ‚¬   rÃ»   rÃ¼   z--batch-sizezsize of each image batchz
--img-sizezinference size (pixels)z--conf-threszobject confidence thresholdz
--iou-thresgÃÃŒÃŒÃŒÃŒÃŒÃ¤?zIOU threshold for NMSz--taskr.   z train, val, test, speed or study)rÃ»   rÃ¼   z--devicez%cuda device, i.e. 0 or 0,1,2,3 or cpuz--single-clsÃš
store_trueztreat as single-class dataset)ÃšactionrÃ¼   z	--augmentzaugmented inferencez	--verbosezreport mAP by classz
--save-txtzsave results to *.txtz
--save-hybridz-save label+prediction hybrid results to *.txtz
--save-confz%save confidences in --save-txt labelsz
--save-jsonz+save a cocoapi-compatible JSON results filez	--projectz	runs/testzsave to project/namez--nameÃšexpz
--exist-okz*existing project/name ok, do not incrementz
--no-tracezdon`t trace modelz
--v5-metricz.assume maximum recall as 1.0 in AP calculationr%   r,   )rÃŠ   rÃ‹   rÃŒ   rÃ   rh   Zspeedg      Ã?gÃÃŒÃŒÃŒÃŒÃŒÃœ?)rÃ…   rÃ   rh   ZstudyÃ©   iâ‚¬  Ã©â‚¬   Zstudy_rÃ    rN   z	
Running z  point z...)rÃ   rh   z%10.4g)Ãšfmtzzip -r study.zip study_*.txt)rD   )SÃšargparserÂº   ÃšosÃš pathlibr   Ãš	threadingr   Ãšnumpyre   râ€°   râ€    r   Ãšmodels.experimentalr   Ãšutils.datasetsr   Ãš
utils.generalr    r   r	   r
   r
   r   r
   r   r   r   r   r   r   Z
utils.metricsr   r   Ãš
utils.plotsr   r   r   Ãšutils.torch_utilsr   r   r   r/   Ãš__name__ÃšArgumentParserÃšparserÃšadd_argumentrq   rT   rB   Ãš
parse_argsr{   rÃ…   rÃ‚   râ€   râ€™   râ€˜   rÃƒ   r   Ãšimg_sizerI   rJ   rÃ†   rA   rÃ‡   rÃŠ   rÃ‹   rÃŒ   Zno_tracerh   ru   rÂµ   râ„¢   rD   rx   rs   ÃšyrG   rÃ”   rÃ    rÃ£   rÅ“   Ãš savetxtÃšsystemr3   r3   r3   r7   Ãš<module>   sÃ†   <Ãª
  

Ã²

(
 Ã¿

